variables:
  MONO_VERSION: 6_4_0
  NETCORE_TEST_VERSION: '2.2.x'
  BuildConfiguration: 'Release'

trigger:
  branches:
    include:
    - master

jobs:
  - job: android_build_and_release
    pool:
        vmImage: macOS-10.14
        demands:
        - MSBuild
        - Xamarin.Android
        - AndroidSDK
    steps:
    - bash: |
        sudo $AGENT_HOMEDIRECTORY/scripts/select-xamarin-sdk.sh $(MONO_VERSION)
        mono --version
      displayName: 'Set mono version'
      condition: and(succeeded(), eq(variables['imageName'], 'macos-10.14'))
    - task: UseDotNet@2
      displayName: 'Use .Net Core sdk $(NETCORE_TEST_VERSION)'
      inputs:
        version: $(NETCORE_TEST_VERSION)
    - task: NuGetToolInstaller@1
      displayName: 'Use NuGet 5.x'
      inputs:
        versionSpec: 5.x
    - task: NuGetCommand@2
      displayName: 'NuGet restore'
    - bash: |
        bash pre_build.sh
      workingDirectory: Build
      displayName: 'Update App Secret'
    - task: XamarinAndroid@1
      displayName: 'Build Android project'
      inputs:
        projectFile: InAppUpdateDemo.Android/InAppUpdateDemo.Android.csproj
        outputDirectory: '$(build.binariesdirectory)/$(BuildConfiguration)'
        configuration: '$(BuildConfiguration)'
    - task: CopyFiles@2
      displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
      inputs:
        SourceFolder: '$(build.binariesdirectory)/$(BuildConfiguration)'
        Contents: '**/*.apk'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'
        flattenFolders: true
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: package'
      inputs:
        ArtifactName: Android
